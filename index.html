import React, { useState, useEffect } from 'react';
import { 
  Github, 
  Linkedin, 
  Mail, 
  ExternalLink, 
  Search,
  ListChecks,
  Bug,
  RefreshCw,
  CheckCircle,
  Plug,
  Gauge,
  Database,
  Bot,
  Puzzle,
  Ticket,
  Moon, 
  Sun,
  Menu,
  X,
  ChevronDown,
  Sparkles // Used for the Gemini-powered feature
} from 'lucide-react';

/**
 * CUSTOMIZE YOUR DATA HERE
 * -----------------------
 * Edit this object to update the portfolio with your own information.
 */
const PORTFOLIO_DATA = {
  personal: {
    name: "Sruthy K",
    role: "Software Tester",
    tagline: "Elevating software quality, one test case at a time.",
    bio: "Passionate about breaking software so your users don't have to. I specialize in uncovering hidden bugs, optimizing performance, and ensuring digital perfection.",
    email: "sruthykrishna045@gmail.com",
    socials: {
      github: "https://github.com",
      linkedin: "https://linkedin.com/in/sruthy-k2003/",
      
    }
  },
  skills: [
  { name: "Manual Testing", icon: Search, level: 90 }, // Added placeholder 'level' for rendering the progress bar
  { name: "Test Case Design", icon: ListChecks, level: 90 },
  { name: "Bug Tracking", icon: Bug, level: 85 },
  { name: "STLC & SDLC", icon: RefreshCw, level: 95 },
  { name: "Regression Testing", icon: CheckCircle, level: 85 },
  { name: "API Testing (Postman)", icon: Plug, level: 75 },
  { name: "Performance Testing (JMeter)", icon: Gauge, level: 80 },
  { name: "SQL / Database Testing", icon: Database, level: 80 },
  { name: "Selenium WebDriver", icon: Bot, level: 85 },
  { name: "TestNG / JUnit", icon: Puzzle, level: 90 },
  { name: "Jira", icon: Ticket, level: 75 }
  ],
  projects: [
    {
      id: 1,
      title: "OrangeHRM Manual Testing",
      description: "A comprehensive testing project for the OrangeHRM web application focused on validating core HR modules such as Login, Employee Management (PIM), Leave, Time, and Dashboard functionality using manual testing.",
      tags: ["Manual Testing", "Test Case Design", "Bug Tracking", "STLC", "Jira"],
      link: "#",
      github: "#",
      image: "https://images.unsplash.com/photo-1581092334709-efc9c2bb2c6c?auto=format&fit=crop&q=80&w=800"
    },
    {
      id: 2,
      title: "Automation Testing Project – ParaBank Web Application",
      description: "Automated critical banking workflows of the ParaBank web application using Selenium WebDriver with Java. The project focused on reducing manual effort by automating repetitive test scenarios and validating core banking functionalities.",
      tags: ["Java", "Selenium WebDriver", "Maven", "TestNG"],
      link: "#",
      github: "#",
      image: "https://images.unsplash.com/photo-1574856342191-ee518e388c3a?auto=format&fit=crop&q=80&w=800"
    },
    {
      id: 3,
      title: "E-Commerce Regression Automation",
      description: "Designed a maintainable Selenium framework to automate critical checkout and payment workflows, significantly reducing the regression cycle time and boosting release confidence.",
      tags: ["Selenium", "TestNG", "Java", "Automation", "E-commerce"],
      link: "#",
      github: "#",
      image: "https://images.unsplash.com/photo-1555099962-4199c345e5dd?auto=format&fit=crop&q=80&w=800"
    }
  ]
};

// Reusable Navigation Component
const Navigation = ({ isDark, toggleTheme }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [scrolled, setScrolled] = useState(false);

  useEffect(() => {
    const handleScroll = () => setScrolled(window.scrollY > 50);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const navLinks = [
    { name: 'About', href: '#about' },
    { name: 'Skills', href: '#skills' },
    { name: 'Projects', href: '#projects' },
    { name: 'Contact', href: '#contact' },
  ];

  return (
    <nav className={`fixed w-full z-50 transition-all duration-300 ${
      scrolled 
        ? (isDark ? 'bg-slate-900/90 backdrop-blur-md shadow-lg' : 'bg-white/90 backdrop-blur-md shadow-md') 
        : 'bg-transparent'
    }`}>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex-shrink-0 font-bold text-2xl bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
            {PORTFOLIO_DATA.personal.name.split(' ')[0]}.
          </div>
          
          {/* Desktop Menu */}
          <div className="hidden md:block">
            <div className="ml-10 flex items-baseline space-x-8">
              {navLinks.map((link) => (
                <a
                  key={link.name}
                  href={link.href}
                  className={`hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                    isDark ? 'text-gray-300' : 'text-gray-700'
                  }`}
                >
                  {link.name}
                </a>
              ))}
              <button
                onClick={toggleTheme}
                className={`p-2 rounded-full transition-colors ${
                  isDark ? 'hover:bg-slate-800 text-yellow-400' : 'hover:bg-gray-100 text-slate-700'
                }`}
              >
                {isDark ? <Sun size={20} /> : <Moon size={20} />}
              </button>
            </div>
          </div>

          {/* Mobile menu button */}
          <div className="md:hidden flex items-center gap-4">
             <button
                onClick={toggleTheme}
                className={`p-2 rounded-full ${
                  isDark ? 'text-yellow-400' : 'text-slate-700'
                }`}
              >
                {isDark ? <Sun size={20} /> : <Moon size={20} />}
              </button>
            <button
              onClick={() => setIsOpen(!isOpen)}
              className={`p-2 rounded-md ${
                isDark ? 'text-gray-400 hover:text-white' : 'text-gray-700 hover:text-black'
              }`}
            >
              {isOpen ? <X size={24} /> : <Menu size={24} />}
            </button>
          </div>
        </div>
      </div>

      {/* Mobile Menu Dropdown */}
      {isOpen && (
        <div className={`md:hidden ${isDark ? 'bg-slate-900' : 'bg-white'} shadow-xl`}>
          <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            {navLinks.map((link) => (
              <a
                key={link.name}
                href={link.href}
                onClick={() => setIsOpen(false)}
                className={`block px-3 py-2 rounded-md text-base font-medium ${
                  isDark ? 'text-gray-300 hover:text-white hover:bg-slate-800' : 'text-gray-700 hover:text-black hover:bg-gray-100'
                }`}
              >
                {link.name}
              </a>
            ))}
          </div>
        </div>
      )}
    </nav>
  );
};

// Reusable Hero Component
const Hero = ({ isDark }) => (
  <section id="about" className="min-h-screen flex items-center justify-center pt-16 relative overflow-hidden">
    {/* Background Decorative Elements */}
    <div className={`absolute top-20 left-10 w-72 h-72 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob ${
      isDark ? 'bg-purple-700' : 'bg-purple-300'
    }`}></div>
    <div className={`absolute top-40 right-10 w-72 h-72 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000 ${
      isDark ? 'bg-blue-700' : 'bg-blue-300'
    }`}></div>
    <div className={`absolute -bottom-8 left-20 w-72 h-72 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-4000 ${
      isDark ? 'bg-pink-700' : 'bg-pink-300'
    }`}></div>

    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
      <h2 className={`text-lg sm:text-xl font-semibold mb-4 tracking-wider uppercase ${
        isDark ? 'text-blue-400' : 'text-blue-600'
      }`}>
        {PORTFOLIO_DATA.personal.role}
      </h2>
      <h1 className={`text-5xl sm:text-7xl font-extrabold mb-6 tracking-tight ${
        isDark ? 'text-white' : 'text-slate-900'
      }`}>
        Hello, I'm <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">{PORTFOLIO_DATA.personal.name}</span>
      </h1>
      <p className={`max-w-2xl mx-auto text-xl sm:text-2xl mb-10 leading-relaxed ${
        isDark ? 'text-gray-300' : 'text-gray-600'
      }`}>
        {PORTFOLIO_DATA.personal.tagline}
      </p>
      
      <div className="flex justify-center gap-6 mb-12">
        <a href={PORTFOLIO_DATA.personal.socials.github} target="_blank" rel="noreferrer" className={`p-3 rounded-full transition-transform hover:-translate-y-1 ${isDark ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-gray-100 text-slate-800 hover:bg-gray-200'}`}>
          <Github size={24} />
        </a>
        <a href={PORTFOLIO_DATA.personal.socials.linkedin} target="_blank" rel="noreferrer" className={`p-3 rounded-full transition-transform hover:-translate-y-1 ${isDark ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-gray-100 text-slate-800 hover:bg-gray-200'}`}>
          <Linkedin size={24} />
        </a>
        <a href={`mailto:${PORTFOLIO_DATA.personal.email}`} className={`p-3 rounded-full transition-transform hover:-translate-y-1 ${isDark ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-gray-100 text-slate-800 hover:bg-gray-200'}`}>
          <Mail size={24} />
        </a>
      </div>

      <a href="#projects" className="inline-flex items-center gap-2 bg-blue-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-blue-700 transition-colors shadow-lg hover:shadow-blue-500/30">
        View My Work
        <ChevronDown size={20} />
      </a>
    </div>
  </section>
);

// Reusable Skills Component
const Skills = ({ isDark }) => (
  <section id="skills" className={`py-24 ${isDark ? 'bg-slate-900' : 'bg-gray-50'}`}>
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div className="text-center mb-16">
        <h2 className={`text-3xl font-bold mb-4 ${isDark ? 'text-white' : 'text-slate-900'}`}>Technical Expertise</h2>
        <div className="w-20 h-1 bg-blue-500 mx-auto rounded-full"></div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {PORTFOLIO_DATA.skills.map((skill, index) => (
          <div 
            key={index} 
            className={`p-6 rounded-2xl border transition-all hover:shadow-xl ${
              isDark 
                ? 'bg-slate-800 border-slate-700 hover:border-blue-500/50' 
                : 'bg-white border-gray-100 hover:border-blue-200'
            }`}
          >
            <div className="flex items-center gap-4 mb-4">
              <div className={`p-3 rounded-lg ${isDark ? 'bg-slate-700 text-blue-400' : 'bg-blue-50 text-blue-600'}`}>
                <skill.icon size={24} />
              </div>
              <h3 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-slate-900'}`}>{skill.name}</h3>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 overflow-hidden">
              <div 
                className="bg-blue-600 h-2.5 rounded-full transition-all duration-1000 ease-out" 
                // We ensure skill.level exists, using 50 as a fallback if necessary
                style={{ width: `${skill.level || 50}%` }}
              ></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>
);

// Projects Component
const Projects = ({ 
  isDark, 
  handleEnhanceDescription, 
  expandedProjectId, 
  loadingId, 
  enhancedDescription, 
  error 
}) => (
  <section id="projects" className={`py-24 ${isDark ? 'bg-slate-950' : 'bg-white'}`}>
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div className="text-center mb-16">
        <h2 className={`text-3xl font-bold mb-4 ${isDark ? 'text-white' : 'text-slate-900'}`}>Featured Projects</h2>
        <p className={`max-w-2xl mx-auto ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
          A selection of projects that showcase my passion for building user-centric solutions.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
        {PORTFOLIO_DATA.projects.map((project) => (
          <div 
            key={project.id} 
            className={`group rounded-2xl overflow-hidden border transition-all hover:-translate-y-2 hover:shadow-2xl ${
              isDark 
                ? 'bg-slate-900 border-slate-800 shadow-slate-900/50' 
                : 'bg-white border-gray-100 shadow-xl shadow-gray-200/50'
            }`}
          >
            <div className="relative overflow-hidden h-48">
              <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              <img 
                src={project.image} 
                alt={project.title} 
                className="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500"
              />
            </div>
            
            <div className="p-6">
              <h3 className={`text-xl font-bold mb-3 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                {project.title}
              </h3>
              
              <p className={`mb-4 line-clamp-3 ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
                {project.description}
              </p>
              
              <div className="flex flex-wrap gap-2 mb-6">
                {project.tags.map((tag) => (
                  <span 
                    key={tag} 
                    className={`text-xs px-3 py-1 rounded-full font-medium ${
                      isDark 
                        ? 'bg-blue-900/30 text-blue-300' 
                        : 'bg-blue-50 text-blue-700'
                    }`}
                  >
                    {tag}
                  </span>
                ))}
              </div>

              {/* NEW GEMINI FEATURE BUTTON */}
              <button
                  onClick={() => handleEnhanceDescription(project)}
                  disabled={loadingId === project.id || (enhancedDescription[project.id] && expandedProjectId === project.id)}
                  className={`mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
                      loadingId === project.id 
                          ? 'bg-gray-500 text-white cursor-not-allowed'
                          : enhancedDescription[project.id] && expandedProjectId === project.id
                              ? 'bg-emerald-600 text-white cursor-not-allowed'
                              : 'bg-yellow-500 text-slate-900 hover:bg-yellow-400'
                  }`}
              >
                  {loadingId === project.id && 
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  }
                  
                  {loadingId === project.id 
                    ? 'Enhancing...' 
                    : enhancedDescription[project.id] 
                      ? expandedProjectId === project.id ? 'Professional Summary Active' : 'Show Professional Summary'
                      : 'Enhance Description ✨'
                  }
                  {!loadingId && !enhancedDescription[project.id] && <Sparkles size={16} />}
              </button>
              
              {/* Expanded Description Area */}
              {(expandedProjectId === project.id && enhancedDescription[project.id]) && (
                  <div className={`mt-4 p-4 rounded-lg border transition-all duration-300 ${isDark ? 'bg-slate-700 border-blue-500/50' : 'bg-blue-50 border-blue-200'}`}>
                      <h4 className={`text-sm font-bold mb-2 ${isDark ? 'text-blue-300' : 'text-blue-800'}`}>
                          Professional Summary (Gemini Generated)
                      </h4>
                      <div 
                          className={`whitespace-pre-wrap text-sm ${isDark ? 'text-gray-200' : 'text-gray-700'}`}
                          // Replace newlines with <br> for HTML rendering of paragraphs
                          dangerouslySetInnerHTML={{ __html: enhancedDescription[project.id].text.replace(/\n\n/g, '<br/><br/>') }}
                      />
                  </div>
              )}

              {/* Error Message */}
              {expandedProjectId === project.id && error && (
                  <p className="mt-4 text-sm text-red-500 font-medium">{error}</p>
              )}


              {/* Existing Links */}
              <div className="flex items-center gap-4 mt-6 border-t pt-4">
                <a 
                  href={project.github} 
                  target="_blank" rel="noreferrer"
                  className={`flex items-center gap-2 text-sm font-semibold transition-colors ${
                    isDark ? 'text-gray-300 hover:text-white' : 'text-gray-600 hover:text-black'
                  }`}
                >
                  <Github size={16} /> Code
                </a>
                <a 
                  href={project.link} 
                  target="_blank" rel="noreferrer"
                  className="flex items-center gap-2 text-sm font-semibold text-blue-600 hover:text-blue-500 transition-colors"
                >
                  <ExternalLink size={16} /> Live Demo
                </a>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>
);


// Reusable Contact Component
const Contact = ({ isDark }) => (
  <section id="contact" className={`py-24 ${isDark ? 'bg-slate-900' : 'bg-gray-50'}`}>
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 className={`text-3xl font-bold mb-8 ${isDark ? 'text-white' : 'text-slate-900'}`}>Let's Work Together</h2>
      <p className={`text-lg mb-12 ${isDark ? 'text-gray-300' : 'text-gray-600'}`}>
        I'm currently available for freelance projects and full-time opportunities.
        If you have a project that needs some creative touch, I'd love to hear about it.
      </p>
      
      <a 
        href={`mailto:${PORTFOLIO_DATA.personal.email}`}
        className="inline-flex items-center gap-3 bg-blue-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-blue-700 transition-all hover:scale-105 shadow-lg shadow-blue-500/30"
      >
        <Mail size={24} />
        Say Hello
      </a>
    </div>
  </section>
);

// Reusable Footer Component
const Footer = ({ isDark }) => (
  <footer className={`py-8 ${isDark ? 'bg-slate-950 text-gray-400' : 'bg-white text-gray-600'} border-t ${isDark ? 'border-slate-800' : 'border-gray-200'}`}>
    <div className="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <p>© {new Date().getFullYear()} {PORTFOLIO_DATA.personal.name}. All rights reserved.</p>
      <div className="flex gap-6">
        <a href={PORTFOLIO_DATA.personal.socials.github} target="_blank" rel="noreferrer" className="hover:text-blue-500 transition-colors">GitHub</a>
        <a href={PORTFOLIO_DATA.personal.socials.linkedin} target="_blank" rel="noreferrer" className="hover:text-blue-500 transition-colors">LinkedIn</a>
      </div>
    </div>
  </footer>
);

// Main App Component
export default function App() {
  const [isDark, setIsDark] = useState(true);
  const [expandedProjectId, setExpandedProjectId] = useState(null);
  const [enhancedDescription, setEnhancedDescription] = useState({});
  const [loadingId, setLoadingId] = useState(null);
  const [error, setError] = useState(null);

  const toggleTheme = () => setIsDark(!isDark);

  // --- Gemini API Call Function with Exponential Backoff ---
  const callGeminiAPI = async (userQuery) => {
      // System prompt for QA resume writer persona
      const systemPrompt = `You are a professional resume writer and career coach specializing in Software Quality Assurance (QA). Your task is to take a brief description of a QA/Testing project and rewrite it into a detailed, two-paragraph, high-impact summary suitable for a professional portfolio. Focus on quantifiable results (if implied), technical skills used (e.g., test case design, automation, bug tracking), and the business impact of the testing. Do not use markdown (like **bold**) or include a title in your response.`;
      const apiKey = ""; 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      const payload = {
          contents: [{ parts: [{ text: userQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
      };

      let result = null;
      let attempts = 0;
      const MAX_RETRIES = 5;

      while (attempts < MAX_RETRIES) {
          try {
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });

              if (response.status === 429) {
                  const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
                  await new Promise(resolve => setTimeout(resolve, delay));
                  attempts++;
                  continue;
              }

              if (!response.ok) {
                  throw new Error(`API error: ${response.statusText}`);
              }

              result = await response.json();
              break; // Success
          } catch (e) {
              if (attempts < MAX_RETRIES - 1) {
                  const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
                  await new Promise(resolve => setTimeout(resolve, delay));
                  attempts++;
              } else {
                  throw e; // Last attempt failed
              }
          }
      }
      
      if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
          return { 
              text: result.candidates[0].content.parts[0].text, 
              sources: []
          };
      } else {
          throw new Error("Failed to generate content from LLM. Check the console for details.");
      }
  };

  // --- Handler for the Enhance Button ---
  const handleEnhanceDescription = async (project) => {
      // If already enhanced, just toggle the view
      if (enhancedDescription[project.id]) {
          setExpandedProjectId(expandedProjectId === project.id ? null : project.id);
          return;
      }
      
      if (loadingId === project.id) return;

      setLoadingId(project.id);
      setError(null);
      setExpandedProjectId(project.id); // Ensure the section is visible during loading

      const userQuery = `Project Title: ${project.title}. Brief description: "${project.description}". Focus on the listed technologies: ${project.tags.join(', ')}.`;
      
      try {
          const result = await callGeminiAPI(userQuery);
          setEnhancedDescription(prev => ({
              ...prev,
              [project.id]: { text: result.text, sources: result.sources }
          }));
      } catch (e) {
          console.error("Gemini API Error:", e);
          setError("Failed to enhance description. The AI service may be temporarily unavailable. Please try again.");
      } finally {
          setLoadingId(null);
      }
  };

  return (
    <div className={`min-h-screen transition-colors duration-300 ${isDark ? 'bg-slate-950 text-white' : 'bg-white text-slate-900'}`}>
      <Navigation isDark={isDark} toggleTheme={toggleTheme} />
      <Hero isDark={isDark} />
      <Skills isDark={isDark} />
      <Projects 
        isDark={isDark} 
        handleEnhanceDescription={handleEnhanceDescription}
        expandedProjectId={expandedProjectId}
        loadingId={loadingId}
        enhancedDescription={enhancedDescription}
        error={error}
      />
      <Contact isDark={isDark} />
      <Footer isDark={isDark} />
    </div>
  );
}
